<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BioLog - Journal Sant√© & Analyse IA</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1a1a1a;
            --text-light: #707070;
            --accent: #27ae60;
            --symptom: #9b59b6;
            --danger: #ff4757;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
        }

        header {
            background: var(--card-bg);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .container {
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            background: none;
            cursor: pointer;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: #f9f9f9;
            font-size: 1rem;
            margin-bottom: 8px;
            font-family: inherit;
        }

        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 5px;
            margin-bottom: 15px;
        }

        .suggestion-chip {
            background: #eef5ff;
            color: var(--primary);
            border: 1px solid #d0e3ff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .symptoms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .symptom-checkbox { display: none; }
        .symptom-label {
            display: block;
            padding: 12px 10px;
            background: #f0f0f0;
            border-radius: 12px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .symptom-checkbox:checked + .symptom-label {
            background: #f3ebf7;
            border-color: var(--symptom);
            color: var(--symptom);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius);
            border: none;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-ai { background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; }
        .btn-danger { background: #fff1f2; color: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid #e0e0e0; color: var(--text-light); }

        .log-entry {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 12px;
            border-left: 5px solid var(--primary);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }

        .log-date { font-weight: 700; }
        .log-type { background: #eef5ff; color: var(--primary); padding: 2px 8px; border-radius: 6px; }

        .log-label { font-weight: 700; color: var(--text-light); font-size: 0.75rem; display: block; }

        .badge {
            background: #f3ebf7;
            color: var(--symptom);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 5px;
            display: inline-block;
            margin-top: 5px;
        }

        #message-box {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 15px;
            border-radius: 12px;
            background: #333;
            color: white;
            text-align: center;
            display: none;
            z-index: 2000;
        }

        #ai-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: none;
            padding: 20px;
        }

        .ai-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            margin: 40px auto;
            max-height: 85vh;
            overflow-y: auto;
        }

        .ai-result {
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    </style>
</head>
<body>

<div id="message-box"></div>

<!-- Modal IA -->
<div id="ai-modal" onclick="this.style.display='none'">
    <div class="ai-card" onclick="event.stopPropagation()">
        <h2 id="ai-title" style="margin-top:0; color:var(--symptom)">Analyse IA</h2>
        <div id="ai-content" class="ai-result">Calcul en cours...</div>
        <button class="btn btn-outline" style="margin-top:20px" onclick="document.getElementById('ai-modal').style.display='none'">Fermer</button>
    </div>
</div>

<header>
    <h1>BIOLOG JOURNAL</h1>
</header>

<div class="container">
    <!-- ONGLET SAISIE -->
    <div id="tab-add" class="tab-content active">
        <form id="logForm">
            <div class="card">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div style="flex: 1;">
                        <label>Heure</label>
                        <input type="time" id="time" required>
                    </div>
                </div>
                
                <label>Moment du repas</label>
                <select id="type">
                    <option value="Petit-d√©jeuner">Petit-d√©jeuner</option>
                    <option value="D√©jeuner">D√©jeuner</option>
                    <option value="D√Æner">D√Æner</option>
                    <option value="Collation">Collation</option>
                    <option value="Sympt√¥me seul">Sympt√¥me seul (hors repas)</option>
                </select>

                <label>Contenu du repas</label>
                <textarea id="foods" placeholder="Ex: P√¢tes au fromage, tomate..." rows="3"></textarea>
                <div id="food-suggestions" class="suggestions-container"></div>
                
                <label>Boisson</label>
                <input type="text" id="drinks" placeholder="Ex: Eau gazeuse, jus d'orange...">
            </div>

            <div class="card">
                <label>Sympt√¥mes ressentis</label>
                <div class="symptoms-grid">
                    <div>
                        <input type="checkbox" id="s1" class="symptom-checkbox" value="Mal de ventre">
                        <label for="s1" class="symptom-label">Mal de ventre</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s2" class="symptom-checkbox" value="Ballonnement">
                        <label for="s2" class="symptom-label">Ballonnement</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s3" class="symptom-checkbox" value="Diarrh√©e">
                        <label for="s3" class="symptom-label">Diarrh√©e</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s4" class="symptom-checkbox" value="Constipation">
                        <label for="s4" class="symptom-label">Constipation</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s5" class="symptom-checkbox" value="Naus√©es">
                        <label for="s5" class="symptom-label">Naus√©es</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s6" class="symptom-checkbox" value="Fatigue">
                        <label for="s6" class="symptom-label">Fatigue</label>
                    </div>
                </div>
                <input type="text" id="other_s" placeholder="Note ou autre sympt√¥me...">
            </div>

            <button type="submit" class="btn btn-primary">Enregistrer l'entr√©e</button>
        </form>
    </div>

    <!-- ONGLET JOURNAL -->
    <div id="tab-list" class="tab-content">
        <button onclick="analyzeTendencies()" class="btn btn-ai">‚ú® Analyser mes tendances (IA)</button>
        <div id="logsContainer"></div>
        <button onclick="clearHistory()" class="btn btn-danger" style="margin-top: 20px; font-size: 0.8rem; padding: 10px;">Vider tout l'historique</button>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('add')">
        <span class="nav-icon">üìù</span>
        <span>Saisir</span>
    </button>
    <button class="nav-item" onclick="switchTab('list')">
        <span class="nav-icon">üìñ</span>
        <span>Journal</span>
    </button>
</nav>

<script>
    // Cl√© API int√©gr√©e
    const apiKey = "AIzaSyBDQuEyGu4g2HHjxwsMQqBAVAMTWX8inKw"; 

    let logs = JSON.parse(localStorage.getItem('biolog_logs')) || [];

    window.onload = () => {
        resetDateTime();
        renderLogs();
        updateSuggestions();
    };

    function resetDateTime() {
        const now = new Date();
        document.getElementById('date').value = now.toISOString().split('T')[0];
        document.getElementById('time').value = now.toTimeString().slice(0,5);
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        const index = tab === 'add' ? 0 : 1;
        document.querySelectorAll('.nav-item')[index].classList.add('active');
        if(tab === 'list') renderLogs();
    }

    document.getElementById('logForm').onsubmit = (e) => {
        e.preventDefault();
        const entry = {
            id: Date.now(),
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            type: document.getElementById('type').value,
            foods: document.getElementById('foods').value.trim(),
            drinks: document.getElementById('drinks').value.trim(),
            symptoms: []
        };

        document.querySelectorAll('.symptom-checkbox:checked').forEach(cb => entry.symptoms.push(cb.value));
        const other = document.getElementById('other_s').value.trim();
        if(other) entry.symptoms.push(other);

        logs.unshift(entry);
        localStorage.setItem('biolog_logs', JSON.stringify(logs));
        
        showMessage("Entr√©e enregistr√©e !");
        document.getElementById('logForm').reset();
        resetDateTime();
        document.querySelectorAll('.symptom-checkbox').forEach(cb => cb.checked = false);
        updateSuggestions();
        switchTab('list');
    };

    function renderLogs() {
        const container = document.getElementById('logsContainer');
        container.innerHTML = logs.length === 0 ? '<p style="text-align:center; color:gray; margin-top:20px;">Aucune donn√©e enregistr√©e</p>' : '';

        logs.forEach(log => {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `
                <div class="log-header">
                    <span class="log-date">${log.date} @ ${log.time}</span>
                    <span class="log-type">${log.type}</span>
                </div>
                <div>
                    ${log.foods ? `<div><span class="log-label">REPAS</span>${log.foods}</div>` : ''}
                    ${log.drinks ? `<div><span class="log-label">BOISSON</span>${log.drinks}</div>` : ''}
                    ${log.symptoms.length > 0 ? `<div style="margin-top:5px">${log.symptoms.map(s => `<span class="badge">${s}</span>`).join('')}</div>` : ''}
                </div>
                <button onclick="deleteEntry(${log.id})" style="background:none; border:none; color:red; font-size:0.7rem; padding:0; margin-top:10px; cursor:pointer;">Supprimer l'entr√©e</button>
            `;
            container.appendChild(div);
        });
    }

    function deleteEntry(id) {
        if(confirm("Supprimer cette entr√©e ?")) {
            logs = logs.filter(l => l.id !== id);
            localStorage.setItem('biolog_logs', JSON.stringify(logs));
            renderLogs();
            updateSuggestions();
        }
    }

    function clearHistory() {
        if(confirm("Effacer tout votre journal ? Cette action est d√©finitive.")) {
            logs = [];
            localStorage.removeItem('biolog_logs');
            renderLogs();
            updateSuggestions();
        }
    }

    async function analyzeTendencies() {
        if (logs.length < 3) {
            showMessage("Enregistrez au moins 3 entr√©es pour analyser.", "error");
            return;
        }

        const modal = document.getElementById('ai-modal');
        const content = document.getElementById('ai-content');
        const title = document.getElementById('ai-title');
        
        modal.style.display = 'block';
        title.textContent = "Analyse Intelligence IA";
        content.innerHTML = "L'IA analyse vos donn√©es<span class='loading-dots'></span>";

        if (!apiKey || apiKey === "") {
            useFallbackAnalysis(content);
            return;
        }

        // Pr√©paration des donn√©es pour l'IA
        const historyText = logs.slice(0, 30).map(l => {
            return `Repas: ${l.foods || 'N/A'}, Boisson: ${l.drinks || 'N/A'}, Sympt√¥mes: ${l.symptoms.join(', ') || 'Aucun'}`;
        }).join('\n');

        const prompt = `En tant qu'assistant sp√©cialis√© dans le suivi alimentaire, analyse ce journal. 
        Cherche des corr√©lations probables entre certains aliments et les sympt√¥mes.
        Donne une r√©ponse synth√©tique et bienveillante en 4 √† 5 phrases maximum.
        Ne donne JAMAIS de diagnostic m√©dical d√©finitif.
        
        Journal des derniers jours :
        ${historyText}`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.3 }
                })
            });

            if (!response.ok) throw new Error();

            const data = await response.json();
            let aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "L'IA n'a pas pu g√©n√©rer d'analyse.";
            content.innerHTML = aiResponse.replace(/[*#]/g, '').trim();

        } catch (e) {
            useFallbackAnalysis(content);
        }
    }

    function useFallbackAnalysis(content) {
        document.getElementById('ai-title').textContent = "Analyse Statistique Locale";
        const counts = {};
        logs.forEach(l => l.symptoms.forEach(s => counts[s] = (counts[s] || 0) + 1));
        const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
        
        let html = "<strong>Note :</strong> La cl√© IA semble invalide ou la connexion a √©chou√©. Voici vos statistiques locales :<br><br>";
        
        if(sorted.length > 0) {
            html += "Sympt√¥mes les plus fr√©quents :<br>";
            sorted.slice(0, 3).forEach(([symptom, count]) => {
                html += `‚Ä¢ <b>${symptom}</b> : enregistr√© ${count} fois<br>`;
            });
            html += `<br><small>Continuez √† remplir le journal pour affiner ces donn√©es.</small>`;
        } else {
            html += "Aucun sympt√¥me r√©current identifi√©.";
        }
        content.innerHTML = html;
    }

    function updateSuggestions() {
        const container = document.getElementById('food-suggestions');
        if(!container) return;
        container.innerHTML = "";
        
        // On r√©cup√®re tous les aliments cit√©s
        const allFoods = logs.flatMap(l => (l.foods || '').split(',')).map(f => f.trim()).filter(f => f.length > 2);
        
        // On compte les occurrences de chaque aliment
        const foodCounts = {};
        allFoods.forEach(f => foodCounts[f] = (foodCounts[f] || 0) + 1);
        
        // On ne garde que ceux qui apparaissent au moins 3 fois
        const frequentFoods = Object.entries(foodCounts)
            .filter(([name, count]) => count >= 3)
            .sort((a, b) => b[1] - a[1]) // Du plus fr√©quent au moins fr√©quent
            .map(([name]) => name)
            .slice(0, 10); // Max 10 suggestions
        
        frequentFoods.forEach(food => {
            const chip = document.createElement('div');
            chip.className = 'suggestion-chip';
            chip.textContent = "+ " + food;
            chip.onclick = () => {
                const input = document.getElementById('foods');
                if (input.value.includes(food)) return;
                input.value = input.value ? input.value + ", " + food : food;
            };
            container.appendChild(chip);
        });
    }

    function showMessage(text, type = "success") {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.style.background = type === "error" ? "var(--danger)" : "var(--accent)";
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 3000);
    }
</script>

</body>
</html>
