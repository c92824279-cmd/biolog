<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AetioSympto - Mon Journal de Sant√©</title>
    <style>
        :root {
            --primary: #4a90e2;
            --bg: #f0f2f5;
            --card-bg: #ffffff;
            --text: #1a1a1a;
            --text-light: #707070;
            --accent: #27ae60;
            --symptom: #9b59b6;
            --danger: #ff4757;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            padding-bottom: 80px;
        }

        header {
            background: var(--card-bg);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        h1 {
            margin: 0;
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: 800;
            letter-spacing: -0.5px;
            text-transform: uppercase;
        }

        .container {
            padding: 15px;
            max-width: 500px;
            margin: 0 auto;
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            display: flex;
            justify-content: space-around;
            padding: 12px 0;
            box-shadow: 0 -2px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.75rem;
            font-weight: 600;
            border: none;
            background: none;
            cursor: pointer;
        }

        .nav-item.active { color: var(--primary); }
        .nav-icon { font-size: 1.4rem; margin-bottom: 4px; }

        .card {
            background: var(--card-bg);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-light);
            text-transform: uppercase;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid #e0e0e0;
            background: #f9f9f9;
            font-size: 1rem;
            margin-bottom: 8px;
            font-family: inherit;
        }

        .suggestions-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 5px;
            margin-bottom: 15px;
            min-height: 20px;
        }

        .suggestion-chip {
            background: #eef5ff;
            color: var(--primary);
            border: 1px solid #d0e3ff;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
        }

        .symptoms-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .symptom-checkbox { display: none; }
        .symptom-label {
            display: block;
            padding: 12px 10px;
            background: #f0f0f0;
            border-radius: 12px;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .symptom-checkbox:checked + .symptom-label {
            background: #f3ebf7;
            border-color: var(--symptom);
            color: var(--symptom);
        }

        .btn {
            width: 100%;
            padding: 16px;
            border-radius: var(--radius);
            border: none;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-ai { background: linear-gradient(135deg, #6e8efb, #a777e3); color: white; }
        .btn-danger { background: #fff1f2; color: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid #e0e0e0; color: var(--text-light); }

        .log-entry {
            background: white;
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 12px;
            border-left: 5px solid var(--primary);
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }

        .log-date { font-weight: 700; }
        .log-type { background: #eef5ff; color: var(--primary); padding: 2px 8px; border-radius: 6px; }

        .log-label { font-weight: 700; color: var(--text-light); font-size: 0.75rem; display: block; }

        .badge {
            background: #f3ebf7;
            color: var(--symptom);
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-right: 5px;
            display: inline-block;
            margin-top: 5px;
        }

        #message-box {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            padding: 15px;
            border-radius: 12px;
            background: #333;
            color: white;
            text-align: center;
            display: none;
            z-index: 2000;
        }

        #confirm-modal {
            display:none; 
            position:fixed; 
            top:0; left:0; right:0; bottom:0; 
            background:rgba(0,0,0,0.5); 
            z-index:4000; 
            align-items:center; 
            justify-content:center;
        }

        .modal-box {
            background:white; padding:20px; border-radius:12px; width:90%; max-width:320px; text-align:center; box-shadow:0 4px 20px rgba(0,0,0,0.2);
        }

        #ai-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 3000;
            display: none;
            padding: 20px;
        }

        .ai-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            margin: 40px auto;
            max-height: 85vh;
            overflow-y: auto;
        }

        .ai-result {
            line-height: 1.6;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }

        .loading-dots:after {
            content: '.';
            animation: dots 1.5s steps(5, end) infinite;
        }
        @keyframes dots { 0%, 20% { content: '.'; } 40% { content: '..'; } 60% { content: '...'; } }
    </style>
</head>
<body>

<div id="message-box"></div>

<!-- Modal Confirmation -->
<div id="confirm-modal">
    <div class="modal-box">
        <p id="confirm-msg" style="margin-bottom:20px; font-weight:bold; color:var(--text);"></p>
        <div style="display:flex; justify-content:space-between; gap:10px;">
            <button onclick="closeConfirm()" class="btn btn-outline" style="margin:0; padding:12px;">Annuler</button>
            <button id="confirm-btn" class="btn btn-danger" style="margin:0; padding:12px;">Confirmer</button>
        </div>
    </div>
</div>

<!-- Modal IA -->
<div id="ai-modal" onclick="this.style.display='none'">
    <div class="ai-card" onclick="event.stopPropagation()">
        <h2 id="ai-title" style="margin-top:0; color:var(--symptom)">Analyse Sant√©</h2>
        <div id="ai-content" class="ai-result">Connexion s√©curis√©e...</div>
        <button class="btn btn-outline" style="margin-top:20px" onclick="document.getElementById('ai-modal').style.display='none'">Fermer</button>
    </div>
</div>

<header>
    <h1>AetioSympto</h1>
</header>

<div class="container">
    <div id="tab-add" class="tab-content active">
        <form id="logForm">
            <div class="card">
                <div style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>Date</label>
                        <input type="date" id="date" required>
                    </div>
                    <div style="flex: 1;">
                        <label>Heure</label>
                        <input type="time" id="time" required>
                    </div>
                </div>
                
                <label>Moment du repas</label>
                <select id="type">
                    <option value="Petit-d√©jeuner">Petit-d√©jeuner</option>
                    <option value="D√©jeuner">D√©jeuner</option>
                    <option value="D√Æner">D√Æner</option>
                    <option value="Collation">Collation</option>
                    <option value="Sympt√¥me isol√©">Sympt√¥me isol√©</option>
                </select>

                <label>Aliments consomm√©s</label>
                <textarea id="foods" placeholder="Ex: Pain complet, ≈ìuf, avocat..." rows="3"></textarea>
                <div id="food-suggestions" class="suggestions-container"></div>
                
                <label>Boisson</label>
                <input type="text" id="drinks" placeholder="Ex: Th√© vert, eau min√©rale...">
                <div id="drink-suggestions" class="suggestions-container"></div>

                <label>M√©dicaments / Compl√©ments</label>
                <input type="text" id="meds" placeholder="Ex: Probiotiques, parac√©tamol...">
                <div id="med-suggestions" class="suggestions-container"></div>
            </div>

            <div class="card">
                <label>Sympt√¥mes fr√©quents</label>
                <div class="symptoms-grid">
                    <div>
                        <input type="checkbox" id="s1" class="symptom-checkbox" value="Mal de ventre">
                        <label for="s1" class="symptom-label">Mal de ventre</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s2" class="symptom-checkbox" value="Ballonnement">
                        <label for="s2" class="symptom-label">Ballonnement</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s3" class="symptom-checkbox" value="Diarrh√©e">
                        <label for="s3" class="symptom-label">Diarrh√©e</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s4" class="symptom-checkbox" value="Constipation">
                        <label for="s4" class="symptom-label">Constipation</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s5" class="symptom-checkbox" value="Naus√©es">
                        <label for="s5" class="symptom-label">Naus√©es</label>
                    </div>
                    <div>
                        <input type="checkbox" id="s6" class="symptom-checkbox" value="Fatigue">
                        <label for="s6" class="symptom-label">Fatigue</label>
                    </div>
                </div>
                <label>Autres sympt√¥mes ou d√©tails</label>
                <input type="text" id="other_s" placeholder="Ex: Migraine, intensit√© 4/10...">
                <div id="symptom-suggestions" class="suggestions-container"></div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button type="button" id="cancel-edit-btn" class="btn btn-outline" style="display: none;" onclick="cancelEdit()">Annuler</button>
                <button type="submit" id="submit-btn" class="btn btn-primary">Enregistrer l'entr√©e</button>
            </div>
        </form>
    </div>

    <div id="tab-list" class="tab-content">
        <button onclick="analyzeTendencies()" class="btn btn-ai">‚ú® Analyser les causes (IA)</button>
        <div id="logsContainer"></div>
        <button onclick="clearHistory()" class="btn btn-danger" style="margin-top: 20px; font-size: 0.8rem;">R√©initialiser l'historique</button>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('add')">
        <span class="nav-icon">üìù</span>
        <span>Saisir</span>
    </button>
    <button class="nav-item" onclick="switchTab('list')">
        <span class="nav-icon">üìñ</span>
        <span>Journal</span>
    </button>
</nav>

<script>
    const apiKey = ""; 

    let logs = JSON.parse(localStorage.getItem('biolog_logs')) || [];
    let editingId = null;

    window.onload = () => {
        resetDateTime();
        renderLogs();
        updateSuggestions();
    };

    function resetDateTime() {
        const now = new Date();
        document.getElementById('date').value = now.toISOString().split('T')[0];
        document.getElementById('time').value = now.toTimeString().slice(0,5);
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        document.getElementById('tab-' + tab).classList.add('active');
        const index = tab === 'add' ? 0 : 1;
        document.querySelectorAll('.nav-item')[index].classList.add('active');
        if(tab === 'list') renderLogs();
    }

    document.getElementById('logForm').onsubmit = (e) => {
        e.preventDefault();
        const entry = {
            id: editingId ? editingId : Date.now(),
            date: document.getElementById('date').value,
            time: document.getElementById('time').value,
            type: document.getElementById('type').value,
            foods: document.getElementById('foods').value.trim(),
            drinks: document.getElementById('drinks').value.trim(),
            meds: document.getElementById('meds').value.trim(),
            symptoms: []
        };

        document.querySelectorAll('.symptom-checkbox:checked').forEach(cb => entry.symptoms.push(cb.value));
        const other = document.getElementById('other_s').value.trim();
        if(other) entry.symptoms.push(other);

        if (editingId) {
            const index = logs.findIndex(l => l.id === editingId);
            if (index !== -1) logs[index] = entry;
            showMessage("Modifi√© !");
        } else {
            logs.unshift(entry);
            showMessage("Enregistr√© !");
        }
        
        localStorage.setItem('biolog_logs', JSON.stringify(logs));
        cancelEdit();
        updateSuggestions();
        switchTab('list');
    };

    function cancelEdit() {
        editingId = null;
        document.getElementById('logForm').reset();
        resetDateTime();
        document.querySelectorAll('.symptom-checkbox').forEach(cb => cb.checked = false);
        document.getElementById('submit-btn').textContent = "Enregistrer l'entr√©e";
        document.getElementById('cancel-edit-btn').style.display = "none";
    }

    function editEntry(id) {
        const log = logs.find(l => l.id === id);
        if(!log) return;
        
        editingId = id;
        document.getElementById('date').value = log.date;
        document.getElementById('time').value = log.time;
        document.getElementById('type').value = log.type;
        document.getElementById('foods').value = log.foods || '';
        document.getElementById('drinks').value = log.drinks || '';
        document.getElementById('meds').value = log.meds || '';
        
        document.querySelectorAll('.symptom-checkbox').forEach(cb => {
            cb.checked = (log.symptoms || []).includes(cb.value);
        });
        
        const standardSymptoms = ["Mal de ventre", "Ballonnement", "Diarrh√©e", "Constipation", "Naus√©es", "Fatigue"];
        const otherSymptoms = (log.symptoms || []).filter(s => !standardSymptoms.includes(s));
        document.getElementById('other_s').value = otherSymptoms.join(', ');
        
        document.getElementById('submit-btn').textContent = "Mettre √† jour";
        document.getElementById('cancel-edit-btn').style.display = "block";
        switchTab('add');
    }

    function renderLogs() {
        const container = document.getElementById('logsContainer');
        container.innerHTML = logs.length === 0 ? '<p style="text-align:center; color:gray; margin-top:20px;">Aucune entr√©e</p>' : '';

        logs.forEach(log => {
            const div = document.createElement('div');
            div.className = 'log-entry';
            div.innerHTML = `
                <div class="log-header">
                    <span class="log-date">${log.date} - ${log.time}</span>
                    <span class="log-type">${log.type}</span>
                </div>
                <div>
                    ${log.foods ? `<div><span class="log-label">REPAS</span>${log.foods}</div>` : ''}
                    ${log.drinks ? `<div><span class="log-label">BOISSON</span>${log.drinks}</div>` : ''}
                    ${log.meds ? `<div><span class="log-label">M√âDICAMENTS</span>${log.meds}</div>` : ''}
                    ${log.symptoms && log.symptoms.length > 0 ? `<div style="margin-top:5px">${log.symptoms.map(s => `<span class="badge">${s}</span>`).join('')}</div>` : ''}
                </div>
                <div style="display: flex; gap: 15px; margin-top: 10px;">
                    <button onclick="editEntry(${log.id})" style="background:none; border:none; color:var(--primary); font-size:0.75rem; padding:0; cursor:pointer; font-weight:700;">‚úé Modifier</button>
                    <button onclick="deleteEntry(${log.id})" style="background:none; border:none; color:var(--danger); font-size:0.75rem; padding:0; cursor:pointer; font-weight:700;">√ó Supprimer</button>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function deleteEntry(id) {
        showConfirm("Supprimer cette entr√©e ?", () => {
            logs = logs.filter(l => l.id !== id);
            localStorage.setItem('biolog_logs', JSON.stringify(logs));
            renderLogs();
            updateSuggestions();
        });
    }

    function clearHistory() {
        showConfirm("Effacer tout ?", () => {
            logs = [];
            localStorage.removeItem('biolog_logs');
            renderLogs();
            updateSuggestions();
        });
    }

    function showConfirm(msg, action) {
        document.getElementById('confirm-msg').textContent = msg;
        confirmAction = action;
        document.getElementById('confirm-modal').style.display = 'flex';
    }
    function closeConfirm() {
        document.getElementById('confirm-modal').style.display = 'none';
        confirmAction = null;
    }
    document.getElementById('confirm-btn').onclick = () => {
        if(confirmAction) confirmAction();
        closeConfirm();
    };

    // LOGIQUE DE SUGGESTIONS (Minimum 3 fois)
    function updateSuggestions() {
        const threshold = 3;
        
        // Aliments
        renderSpecificSuggestions('foods', 'food-suggestions', threshold);
        // Boissons
        renderSpecificSuggestions('drinks', 'drink-suggestions', threshold);
        // M√©dicaments
        renderSpecificSuggestions('meds', 'med-suggestions', threshold);
        // Autres Sympt√¥mes (ceux qui sont dans le champ "other_s" ou l'array symptoms)
        renderSymptomSuggestions('symptom-suggestions', threshold);
    }

    function renderSpecificSuggestions(fieldKey, containerId, threshold) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = "";

        const counts = {};
        logs.forEach(l => {
            const val = l[fieldKey];
            if(val) {
                val.split(',').forEach(item => {
                    const clean = item.trim();
                    if(clean.length >= 1) counts[clean] = (counts[clean] || 0) + 1;
                });
            }
        });

        Object.entries(counts)
            .filter(([name, count]) => count >= threshold)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 8)
            .forEach(([name]) => {
                container.appendChild(createChip(name, fieldKey));
            });
    }

    function renderSymptomSuggestions(containerId, threshold) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = "";

        const standard = ["Mal de ventre", "Ballonnement", "Diarrh√©e", "Constipation", "Naus√©es", "Fatigue"];
        const counts = {};
        
        logs.forEach(l => {
            (l.symptoms || []).forEach(s => {
                if(!standard.includes(s) && s.length >= 1) {
                    counts[s] = (counts[s] || 0) + 1;
                }
            });
        });

        Object.entries(counts)
            .filter(([name, count]) => count >= threshold)
            .sort((a,b) => b[1] - a[1])
            .slice(0, 8)
            .forEach(([name]) => {
                container.appendChild(createChip(name, 'other_s'));
            });
    }

    function createChip(name, targetId) {
        const chip = document.createElement('div');
        chip.className = 'suggestion-chip';
        chip.textContent = "+ " + name;
        chip.onclick = () => {
            const input = document.getElementById(targetId);
            const values = input.value.split(',').map(v => v.trim()).filter(v => v !== "");
            if (values.includes(name)) return;
            values.push(name);
            input.value = values.join(', ');
        };
        return chip;
    }

    async function analyzeTendencies() {
        if (logs.length < 3) {
            showMessage("Minimum 3 entr√©es requises", "error");
            return;
        }
        const modal = document.getElementById('ai-modal');
        const content = document.getElementById('ai-content');
        modal.style.display = 'block';
        content.innerHTML = "Analyse d√©taill√©e en cours<span class='loading-dots'></span>";

        const historyText = logs.slice(0, 50).map(l => {
            return `${l.date} ${l.time}: ${l.type}, Repas: ${l.foods}, Boisson: ${l.drinks}, M√©doc: ${l.meds}, Sympt√¥mes: ${(l.symptoms || []).join(', ')}`;
        }).join('\n');

        const prompt = `En tant qu'analyste de sant√© expert, examine attentivement ce journal de bord :\n\n${historyText}\n\nFournis une analyse d√©taill√©e, approfondie et structur√©e :\n1. D√©clencheurs potentiels : Identifie pr√©cis√©ment quels aliments, boissons ou m√©dicaments sont le plus souvent associ√©s √† l'apparition des sympt√¥mes.\n2. Sch√©mas r√©currents : Remarques-tu des combinaisons d'aliments ou des moments de la journ√©e particuli√®rement probl√©matiques ?\n3. Hypoth√®ses : Quelles sensibilit√©s ou intol√©rances cela pourrait-il sugg√©rer ?\n4. Pistes d'action : Propose des √©tapes simples pour l'utilisateur (ex: √©viction temporaire).\n\nR√©dige une r√©ponse compl√®te, d√©taill√©e, claire et bienveillante. Rappelle √† la fin que cela ne remplace en aucun cas un avis m√©dical v√©ritable.`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const result = await response.json();
            content.innerHTML = result.candidates[0].content.parts[0].text.replace(/[*#]/g, '').trim();
        } catch (e) {
            content.innerHTML = "Erreur de connexion.";
        }
    }

    function showMessage(text, type = "success") {
        const box = document.getElementById('message-box');
        box.textContent = text;
        box.style.background = type === "error" ? "var(--danger)" : "var(--accent)";
        box.style.display = 'block';
        setTimeout(() => box.style.display = 'none', 2000);
    }
</script>

</body>
</html>
